{"version":3,"sources":["../../../src/models/handlers/map-scroll-handler.ts"],"names":[],"mappings":"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","file":"map-scroll-handler.js","sourceRoot":"","sourcesContent":["import { Observable } from 'rxjs/Observable';\nimport { Subject } from 'rxjs/Subject';\nimport { BehaviorSubject } from 'rxjs/BehaviorSubject';\nimport * as _ from 'lodash';\n\nimport { ScrollTriggerDirective } from '../../directives/scroll-trigger/scroll-trigger.directive';\nimport { ScrollMapItem } from './map-scroll-handler/scroll-map-item';\nimport { ScrollHandler, ScrollHandlerOptions } from './scroll-handler';\n\nexport class MapScrollHandler extends ScrollHandler {\n\n  _scrollMap: ScrollMapItem[];\n  _scrollMapPosition = new BehaviorSubject<{ x: number, y: number }>(undefined);\n  scrollMapItemPositions: {startPosition: number, endPosition: number, item: ScrollMapItem }[] = [];\n\n  constructor(scrollMap: ScrollMapItem[],\n              options: ScrollHandlerOptions) {\n    super(options);\n    this.scrollMap = scrollMap;\n  }\n\n  set scrollMap(scrollMap) {\n    this._scrollMap = scrollMap;\n    this.setInitialPosition();\n  }\n\n  getInstantPosition(): number {\n    return this.element.scrollLeft + this.element.scrollTop;\n  }\n\n  handleResizeEvent() {\n    super.handleResizeEvent();\n    this.updateScrollMapItems();\n    this.updateScrollMapItemPositions();\n  }\n\n  handleScrollEvent(e, deltaX, deltaY, duration, ease = undefined) {\n    let delta = deltaX + deltaY;\n\n    if (this.preventScroll(delta)) {\n      return;\n    }\n\n    const totalDistance = this._scrollMap\n      .map(item => item.getDistance(this.viewportSize))\n      .reduce((sum, current) => sum + current);\n\n    const estimatedPosition = this.position + delta;\n    let position;\n\n    if (estimatedPosition < 0) {\n      position = 0;\n    } else if (estimatedPosition > totalDistance) {\n      position = totalDistance;\n    } else {\n      position = estimatedPosition;\n    }\n\n    this.scrollTo(position, duration, ease, true);\n\n    if (estimatedPosition > position) {\n      this._scrollOverflow.next(estimatedPosition - position);\n    } else if (estimatedPosition < 0) {\n      this._scrollOverflow.next(estimatedPosition);\n    }\n  }\n\n  scrollTo(position, duration, ease = undefined, cancellable = false): Observable<{}> {\n    if (!cancellable) {\n      this.animatingScroll = true;\n    }\n\n    let mapPosition = this.calculateScrollMapPosition(position);\n    let params = {\n      scrollLeft: mapPosition.x,\n      scrollTop: mapPosition.y\n    };\n    let obs = new Subject();\n\n    if (ease) {\n      params['ease'] = ease;\n    }\n\n    params['onComplete'] = () => {\n      obs.next();\n\n      if (!cancellable) {\n        this.animatingScroll = false;\n      }\n    };\n\n    this.previousScrollPosition = this.position;\n\n    if (this._position.value != position) {\n      this._position.next(position);\n    }\n\n    if (this._scrollMapPosition.value == undefined\n      || this._scrollMapPosition.value.x !== mapPosition.x\n      || this._scrollMapPosition.value.y !== mapPosition.y) {\n      this._scrollMapPosition.next(mapPosition);\n    }\n\n    if (duration) {\n      this.timeline = this.timeline.clear().to(this.element, duration, params);\n    } else {\n      this.timeline = this.timeline.clear().set(this.element, params);\n    }\n\n    return obs;\n  }\n\n  calculateScrollMapPosition(position) {\n    let mapDistance = 0;\n    let mapPosition = { x: 0, y: 0 };\n\n    this._scrollMap.forEach(item => {\n      const distance = item.getDistance(this.viewportSize);\n      const percentage = (position - mapDistance) / distance;\n      const insidePosition = item.getPosition(this.viewportSize, percentage);\n\n      if (distance >= 0) {\n        mapDistance += distance;\n      }\n\n      mapPosition.x += insidePosition.x;\n      mapPosition.y += insidePosition.y;\n\n      if (percentage >= 0 && percentage < 1) {\n        return false;\n      }\n    });\n\n    return mapPosition;\n  }\n\n  updateScrollMapItems() {\n    if (!this._scrollMap) {\n      return;\n    }\n    this._scrollMap.forEach(item => item.onLayoutUpdated());\n  }\n\n  get scrollMapPosition(): Observable<{ x: number, y: number }> {\n    return this._scrollMapPosition.asObservable();\n  }\n\n  updateScrollMapItemPositions() {\n    let sum = 0;\n\n    this.scrollMapItemPositions = this._scrollMap.map(item => {\n      const distance = item.getDistance(this.viewportSize);\n      const obj = {\n        startPosition: sum,\n        endPosition: sum + distance,\n        item: item\n      };\n      sum += distance;\n      return obj;\n    });\n  }\n\n  getTriggerPosition(trigger: ScrollTriggerDirective): number {\n    let triggerPosition = super.getTriggerPosition(trigger);\n    const scrollMapItem = _.first(this.scrollMapItemPositions.filter(item => item.item === trigger.scrollMapItem));\n\n    if (scrollMapItem) {\n      triggerPosition += scrollMapItem.startPosition;\n    }\n\n    return triggerPosition;\n  }\n}\n"]}